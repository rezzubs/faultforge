import matplotlib.pyplot as plt
import numpy as np

from faultforge.stats import Stats

stats = Stats.load(
    "/Users/rezzubs/Documents/work/transformers/2026-01-09_2/vit_base-f32-1flip/dataset-ImageNet_dtype-Float32_model-VitBase_ber-3.62e-10.json"
)

accuracy_by_bit = {i: [] for i in range(32)}

for entry in stats.entries:
    assert entry.faulty_parameters is not None
    [fault_mask] = entry.faulty_parameters
    print(bin(fault_mask))

    for i, bit in enumerate(reversed(bin(fault_mask))):
        if bit == "1":
            break
    else:
        raise ValueError(bin(fault_mask))

    accuracy_by_bit[i].append(entry.accuracy)

lower = []
for i in range(29):
    lower.extend(accuracy_by_bit[i])

violins = [accuracy_by_bit[31], accuracy_by_bit[30], accuracy_by_bit[29], lower]

plt.violinplot(violins)

plt.xticks([1, 2, 3, 4], ["31", "30", "29", "28-0"])
plt.ylabel("Accuracy PDF [%]")
plt.xlabel("Bit index")

plt.show()
