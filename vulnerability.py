from pathlib import Path

import matplotlib.pyplot as plt
import numpy as np
from matplotlib.pylab import Axes

from faultforge.stats import Stats

stats_f32 = Stats.load(
    Path(
        "/Users/rezzubs/Documents/work/transformers/2026-01-09_2/vit_base-f32-1flip/dataset-ImageNet_dtype-Float32_model-VitBase_ber-3.62e-10.json"
    )
)
stats_f16 = Stats.load(
    Path(
        "/Users/rezzubs/Documents/work/transformers/2026-01-09_2/vit_base-f16-1flip/dataset-ImageNet_dtype-Float16_model-VitBase_ber-7.23e-10.json"
    )
)


def sort_accuracy(stats, length):
    accuracy_by_bit = {i: [] for i in range(32)}

    for entry in stats.entries:
        assert entry.faulty_parameters is not None
        [fault_mask] = entry.faulty_parameters
        print(bin(fault_mask))

        for i, bit in enumerate(reversed(bin(fault_mask))):
            if bit == "1":
                break
        else:
            raise ValueError(bin(fault_mask))

        accuracy_by_bit[i].append(entry.accuracy)

    return accuracy_by_bit


f32_by_bit = sort_accuracy(stats_f32, 32)

lower_f32 = []
for i in range(29):
    lower_f32.extend(f32_by_bit[i])

violins_f32 = [f32_by_bit[31], f32_by_bit[30], f32_by_bit[29], lower_f32]

f16_by_bit = sort_accuracy(stats_f16, 32)

lower_f16 = []
for i in range(13):
    lower_f16.extend(f16_by_bit[i])

violins_f16 = [f16_by_bit[15], f16_by_bit[14], f16_by_bit[13], lower_f16]

fig, (ax1, ax2) = plt.subplots(1, 2, sharey=True, figsize=(10, 5), layout="tight")

assert isinstance(ax1, Axes)
assert isinstance(ax2, Axes)

ax1.violinplot(violins_f32, showmeans=True)

ax1.set_xticks([1, 2, 3, 4], ["31", "30", "29", "28-0"])
ax1.set_ylabel("Accuracy PDF [%]")
ax1.set_xlabel("Bit index")
ax1.set_title("float32")

ax2.violinplot(violins_f16, showmeans=True)

ax2.set_xticks([1, 2, 3, 4], ["15", "14", "13", "12-0"])
ax2.set_xlabel("Bit index")
ax2.set_title("float16")


plt.show()
